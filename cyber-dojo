#!/bin/bash
set -e

# - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Uses straight delegation (to cyber-dojo-inner script) so
# this script can remain minimal and (hopefully) never need
# updating, even after you've run a [cyber-dojo update].
# NB: There are [cyber-dojo update] tests that predate
#     CYBER_DOJO_COMMANDER_TAG so you can't use that.
# NB: A [cyber-dojo update] command does not update this script.
#     This script must take great care if it exports any env-vars
#     as they would be visible to, and break, previous versions of
#     cyber-dojo-inner (and any scripts it extracts and runs).
# - - - - - - - - - - - - - - - - - - - - - - - - - - - -
readonly VERSIONER=cyberdojo/versioner:latest
readonly ENV_VARS=$(docker run --rm ${VERSIONER} sh -c 'cat /app/.env')
readonly ENV_VAR_NAME=CYBER_DOJO_COMMANDER_SHA=
readonly ENV_VAR=$(echo "${ENV_VARS}" | grep ${ENV_VAR_NAME})
readonly SHA7=${ENV_VAR:${#ENV_VAR_NAME}:7}
readonly COMMANDER_TAG=${COMMANDER_TAG:-${SHA7}}
readonly SCRIPT=cyber-dojo-inner

docker run \
  --entrypoint cat \
  --rm \
  cyberdojo/commander:${COMMANDER_TAG} \
    /app/${SCRIPT} \
      > /tmp/${SCRIPT}

chmod 700 /tmp/${SCRIPT}

/tmp/${SCRIPT} "$@"
