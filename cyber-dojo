#!/bin/bash
set -e

# - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Delegates to cyber-dojo-inner.
# A [cyber-dojo update] does not update this script.
# Does not export any env-vars as they are visible to,
# and easily break, previous versions of cyber-dojo-inner
# (and scripts it extracts and runs) in regression tests.
# - - - - - - - - - - - - - - - - - - - - - - - - - - - -

commander_tag()
{
  # There are [cyber-dojo update] tests that predate
  # the CYBER_DOJO_COMMANDER_TAG env-var being added
  # to versioner's .env file so this function is careful
  # to use the earlier CYBER_DOJO_COMMANDER_SHA
  local -r VERSIONER=cyberdojo/versioner:latest
  local -r ENV_VARS=$(docker run --rm ${VERSIONER} sh -c 'cat /app/.env')
  [[ "${ENV_VARS}" =~ CYBER_DOJO_COMMANDER_SHA=(.*) ]]
  echo "${BASH_REMATCH[1]:0:7}"
}

readonly COMMANDER_TAG="${COMMANDER_TAG:-$(commander_tag)}"
readonly SCRIPT=cyber-dojo-inner

docker run \
  --entrypoint cat \
  --rm \
  cyberdojo/commander:${COMMANDER_TAG} \
    /app/${SCRIPT} \
      > /tmp/${SCRIPT}

chmod 700 /tmp/${SCRIPT}

CYBER_DOJO_COMMANDER_TAG=${COMMANDER_TAG} \
  /tmp/${SCRIPT} "$@"
