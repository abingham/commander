#!/bin/bash
set -e

# - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Uses straight delegation (to cyber-dojo-inner script) so
# this script can remain minimal and (hopefully) never need
# updating, even after you've run a [cyber-dojo update].
# NB: A [cyber-dojo update] does not update this script.
#     So this script must take great care exporting any
#     env-vars as they are visible to, and easily break,
#     previous versions of cyber-dojo-inner (and scripts it
#     extracts and runs) running as regression tests.
# NB: There are [cyber-dojo update] tests that predate the
#     CYBER_DOJO_COMMANDER_TAG env-var being added to
#     versioner's .env file so this script is careful to
#     use the earlier CYBER_DOJO_COMMANDER_SHA
# - - - - - - - - - - - - - - - - - - - - - - - - - - - -

readonly VERSIONER=cyberdojo/versioner:latest
readonly ENV_VARS=$(docker run --rm ${VERSIONER} sh -c 'cat /app/.env')
[[ "${ENV_VARS}" =~ CYBER_DOJO_COMMANDER_SHA=(.*) ]]
readonly COMMANDER_TAG="${COMMANDER_TAG:-${BASH_REMATCH[1]:0:7}}"
readonly SCRIPT=cyber-dojo-inner

docker run \
  --entrypoint cat \
  --rm \
  cyberdojo/commander:${COMMANDER_TAG} \
    /app/${SCRIPT} \
      > /tmp/${SCRIPT}

chmod 700 /tmp/${SCRIPT}

CYBER_DOJO_COMMANDER_TAG=${COMMANDER_TAG} \
  /tmp/${SCRIPT} "$@"
